---
title: "extra_innings"
author: "Paul A. Hodgetts"
date: "02/03/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r install packages, echo=FALSE, message=FALSE, warning=FALSE}
# uncomment any packages that need to be installed

# install tidyverse package
# version 1.3.0
#install.packages("tidyverse")         

# install ggplot2 package
# version 3.3.3
#install.packages("ggplot2")           

# install showtext package
# version 0.9-2
#install.packages("showtext")

# install here package
# version 1.0.1
#install.packages("here")

# install Lahman package
# version 8.0-1
#install.packages("Lahman")

# install retrosheet package
# version 1.1.3
#install.packages("retrosheet")
```

```{r libraries, echo=FALSE, message=FALSE, warning=FALSE}
# loads tidyverse library for working with data
# version 1.3.0
library(tidyverse)

# loads ggplot2 library for creating plots
# version 3.3.3
library(ggplot2)

# loads showtext library for accessing Google fonts
# version 0.9-2
library(showtext)

# load here library for working with directories
# version 1.0.1
library(here)

# load Lahman library for baseball data
# version 8.0-1
library(Lahman)

# load retrosheet package for baseball game data
# version 1.1.3
library(retrosheet)
```



```{r font, echo=FALSE, message=FALSE, warning=FALSE}
# add in fonts from Google fonts using showtext package
# font_add_google function calls the font from Google fonts
font_add_google(name = "Roboto Slab", family = "roboto-serif")
# loads font
showtext_auto()
```

```{r data function, echo=FALSE, message=FALSE, warning=FALSE}
# read in the read_gl() function from script directory
source(here::here("script/read_gl.R"))
```

```{r data extra innings, echo=FALSE, message=FALSE, warning=FALSE}
# read in game log datasets using the read_gl function
read_gl("gl2000_x", "data/gl2000_09/GL2000.TXT")
read_gl("gl2001_x", "data/gl2000_09/GL2001.TXT")
read_gl("gl2002_x", "data/gl2000_09/GL2002.TXT")
read_gl("gl2003_x", "data/gl2000_09/GL2003.TXT")
read_gl("gl2004_x", "data/gl2000_09/GL2004.TXT")
read_gl("gl2005_x", "data/gl2000_09/GL2005.TXT")
read_gl("gl2006_x", "data/gl2000_09/GL2006.TXT")
read_gl("gl2007_x", "data/gl2000_09/GL2007.TXT")
read_gl("gl2008_x", "data/gl2000_09/GL2008.TXT")
read_gl("gl2009_x", "data/gl2000_09/GL2009.TXT")
read_gl("gl2010_x", "data/gl2010_19/GL2010.TXT")
read_gl("gl2011_x", "data/gl2010_19/GL2011.TXT")
read_gl("gl2012_x", "data/gl2010_19/GL2012.TXT")
read_gl("gl2013_x", "data/gl2010_19/GL2013.TXT")
read_gl("gl2014_x", "data/gl2010_19/GL2014.TXT")
read_gl("gl2015_x", "data/gl2010_19/GL2015.TXT")
read_gl("gl2016_x", "data/gl2010_19/GL2016.TXT")
read_gl("gl2017_x", "data/gl2010_19/GL2017.TXT")
read_gl("gl2018_x", "data/gl2010_19/GL2018.TXT")
read_gl("gl2019_x", "data/gl2010_19/GL2019.TXT")
read_gl("gl2020_x", "data/gl2020_20/GL2020.TXT")
```

```{r data regular innings, echo=FALSE, message=FALSE, warning=FALSE}
# read in game log datasets using the read_gl function
read_gl("gl2000_r", "data/gl2000_09/GL2000.TXT")
read_gl("gl2001_r", "data/gl2000_09/GL2001.TXT")
read_gl("gl2002_r", "data/gl2000_09/GL2002.TXT")
read_gl("gl2003_r", "data/gl2000_09/GL2003.TXT")
read_gl("gl2004_r", "data/gl2000_09/GL2004.TXT")
read_gl("gl2005_r", "data/gl2000_09/GL2005.TXT")
read_gl("gl2006_r", "data/gl2000_09/GL2006.TXT")
read_gl("gl2007_r", "data/gl2000_09/GL2007.TXT")
read_gl("gl2008_r", "data/gl2000_09/GL2008.TXT")
read_gl("gl2009_r", "data/gl2000_09/GL2009.TXT")
read_gl("gl2010_r", "data/gl2010_19/GL2010.TXT")
read_gl("gl2011_r", "data/gl2010_19/GL2011.TXT")
read_gl("gl2012_r", "data/gl2010_19/GL2012.TXT")
read_gl("gl2013_r", "data/gl2010_19/GL2013.TXT")
read_gl("gl2014_r", "data/gl2010_19/GL2014.TXT")
read_gl("gl2015_r", "data/gl2010_19/GL2015.TXT")
read_gl("gl2016_r", "data/gl2010_19/GL2016.TXT")
read_gl("gl2017_r", "data/gl2010_19/GL2017.TXT")
read_gl("gl2018_r", "data/gl2010_19/GL2018.TXT")
read_gl("gl2019_r", "data/gl2010_19/GL2019.TXT")
read_gl("gl2020_r", "data/gl2020_20/GL2020.TXT")
```

```{r prepare function, echo=FALSE, message=FALSE, warning=FALSE}
# read in the prepare_gl() function from script directory
source(here::here("script/prepare_gl.R"))
```

```{r prepare extra game logs, echo=FALSE, message=FALSE, warning=FALSE}
# use the prepare_gl function to prepare a given gamelog
prepare_gl("gl2000_x", "extra")
prepare_gl("gl2001_x", "extra")
prepare_gl("gl2002_x", "extra")
prepare_gl("gl2003_x", "extra")
prepare_gl("gl2004_x", "extra")
prepare_gl("gl2005_x", "extra")
prepare_gl("gl2006_x", "extra")
prepare_gl("gl2007_x", "extra")
prepare_gl("gl2008_x", "extra")
prepare_gl("gl2009_x", "extra")
prepare_gl("gl2010_x", "etxra")
prepare_gl("gl2011_x", "extra")
prepare_gl("gl2012_x", "extra")
prepare_gl("gl2013_x", "extra")
prepare_gl("gl2014_x", "extra")
prepare_gl("gl2015_x", "extra")
prepare_gl("gl2016_x", "extra")
prepare_gl("gl2017_x", "extra")
prepare_gl("gl2018_x", "extra")
prepare_gl("gl2019_x", "extra")
prepare_gl("gl2020_x", "extra")
```

```{r prepare regular game logs, echo=FALSE, message=FALSE, warning=FALSE}
# use the prepare_gl function to prepare a given gamelog
prepare_gl("gl2000_r", "regular")
prepare_gl("gl2001_r", "regular")
prepare_gl("gl2002_r", "regular")
prepare_gl("gl2003_r", "regular")
prepare_gl("gl2004_r", "regular")
prepare_gl("gl2005_r", "regular")
prepare_gl("gl2006_r", "regular")
prepare_gl("gl2007_r", "regular")
prepare_gl("gl2008_r", "regular")
prepare_gl("gl2009_r", "regular")
prepare_gl("gl2010_r", "regular")
prepare_gl("gl2011_r", "regular")
prepare_gl("gl2012_r", "regular")
prepare_gl("gl2013_r", "regular")
prepare_gl("gl2014_r", "regular")
prepare_gl("gl2015_r", "regular")
prepare_gl("gl2016_r", "regular")
prepare_gl("gl2017_r", "regular")
prepare_gl("gl2018_r", "regular")
prepare_gl("gl2019_r", "regular")
prepare_gl("gl2020_r", "regular")
```

```{r dataframe vectors, echo=FALSE, message=FALSE, warning=FALSE}
# create temporary holders for data object names ->
# to be removed later
t1 <- ls(pattern = "_r")
t2 <- ls(pattern = "_x")
```

```{r bind datasets, echo=FALSE, message=FALSE, warning=FALSE}
# create a list of all dataframes
dfx <- grepl("_x", names(.GlobalEnv))
# run twice because it changes the number of items in the global environment-- 
# creating issues for the next line
dfx <- grepl("_x", names(.GlobalEnv))
names(dfx) <- names(.GlobalEnv)

# repeat above steps for regular inning games
dfr <- grepl("_r", names(.GlobalEnv))
dfr <- grepl("_r", names(.GlobalEnv))
names(dfr) <- names(.GlobalEnv)

# bind all extra inning dataframes using the created list
extras <- do.call(rbind, mget(names(dfx)[dfx]))

# bind all regular inning dataframes using the created list
reg <- do.call(rbind, mget(names(dfr)[dfr]))
```

```{r remove data objects, echo=FALSE, warning=FALSE, message=FALSE}
# remove the created game log data objects
rm(list = c(t1, t2))
# remove the temporary vectors ->
# and remove dfr and dfx logical vectors
rm(t1, t2, dfr, dfx)
```

```{r missing values, echo=FALSE, message=FALSE, warning=FALSE}
# read in the check_NA() function from script directory
source(here::here("script/check_NA.R"))

# creates dataset of missing value row and column numbers
check_NA(reg, "reg_NA")
check_NA(extras, "extras_NA")

# remove NAs created by ties
reg <- reg %>% 
  filter(!is.na(winning_team))

extras <- extras %>% 
  filter(!is.na(winning_team))

# doublecheck NA values
check_NA(reg, "reg_NA")
check_NA(extras, "extras_NA")
```

```{r extra inning game win count, echo=FALSE}
# extra inning wins/losses totals
extrawin_count <- count(extras, winning_team)
extrawin_count <- extrawin_count %>% 
  rename(count = n) %>% 
  mutate(game_length = "Extra")

# extra inning wins/losses by year
extra_count_yr <- count(extras, winning_team, year) %>% 
  rename(count = n) %>% 
  unique()
```

```{r regular inning game win count, echo=FALSE}
# regular length wins/losses totals
regwin_count <- count(reg, winning_team)
regwin_count <- regwin_count %>% 
  filter(winning_team != "NA") %>% 
  rename(count = n) %>% 
  mutate(game_length = "Regulation")

# regular length wins/losses by year
reg_count_yr <- count(reg, winning_team, year) %>% 
  filter(winning_team != "NA") %>%
  rename(count = n) %>% 
  unique()
```

```{r combined count, echo=FALSE}
# combine the counts for regulation and extra inning games
combined_counts <- bind_rows(regwin_count, extrawin_count)
```

```{r, echo=FALSE, fig.align = "center", message=FALSE, warning=FALSE}
# generate plot using win counts
ggplot(combined_counts, aes(x = winning_team, y = count, fill = winning_team))+
  # generate bar plot, set alpha to .75
  geom_bar(stat = "identity", alpha = 0.75)+
  # set plot labels
  labs(x = "Team Identity (Home or Visitor)",                                                     
       y = "Total Game Count",
       fill = "Legend")+
  # set plot theme to minimal
  theme_minimal()+
  # set plot font to roboto-slab-serif
  theme(text = element_text(family = "roboto-serif"),
        # remove minor grid lines
        panel.grid.minor = element_blank(),
        # remove major x grid lines
        panel.grid.major.x = element_blank(),
        # set y grid lines to blue
        panel.grid.major.y = element_line(colour = "#E0EDF5"),
        # set panel spacing to 10mm
        panel.spacing = unit(10, "mm"))+
  # set colour values
  scale_fill_manual(values = c("#0E1F40", "#f6aa1c"),
                    labels = c("Home", "Visitor"))+
  # set x labels
  scale_x_discrete(labels = c("Home", "Visitor"))+
  # facet wrap by game length
  facet_wrap(vars(game_length),
             scales = "free")
```

```{r, echo=FALSE, fig.height = 7, fig.width = 9, fig.align = "center", message=FALSE, warning=FALSE}
# generate new plot using extra inning wins/losses data
ggplot(extra_count_yr, aes(x = winning_team, y = count, fill = winning_team))+
  # generate bar plot
  geom_bar(stat = "identity", alpha = .75)+
  # set plot labels
  labs(x = "Team Identity (Home or Visitor)",                                                     
       y = "Total Game Count",
       fill = "Legend")+
  # set plot theme to minimal
  theme_minimal()+
  # set plot font to roboto-slab-serif
  theme(text = element_text(family = "roboto-serif"),
        # remove minor grid lines
        panel.grid.minor = element_blank(),
        # remove major x grid lines
        panel.grid.major.x = element_blank(),
        # set major y grid lines to blue
        panel.grid.major.y = element_line(colour = "#E0EDF5"),
        # set panel spacing to 7mm
        panel.spacing = unit(7, "mm"),
        # set legend position to bottom of plot
        legend.position = "bottom",
        # set legend orientation to horizontal
        legend.direction = "horizontal")+
  # set fill values
  scale_fill_manual(values = c("#0E1F40", "#f6aa1c"),
                    labels = c("Home", "Visitor"))+
  # set x labels
  scale_x_discrete(labels = c("Home", "Visitor"))+
  # set y axis values
  scale_y_continuous(expand = expansion(mult = c(0, 0.05)))+
  # facet wrap by year
  facet_wrap(vars(year),
             nrow = 5,
             scales = "free_y")
```

```{r chart4, echo=FALSE, fig.height = 7, fig.width = 9, fig.align = "center", message=FALSE, warning=FALSE}
# generate new plot using regulation inning wins/losses data
ggplot(reg_count_yr, aes(x = winning_team, y = count, fill = winning_team))+
  # generate bar plot
  geom_bar(stat = "identity", alpha = .75)+
  # set plot labels
  labs(x = "Team Identity (Home or Visitor)",                                                     
       y = "Total Game Count",
       fill = "Legend")+
  # set plot theme to minimal
  theme_minimal()+
  # set plot font to roboto-slab-serif
  theme(text = element_text(family = "roboto-serif"),
        # remove minor grid lines
        panel.grid.minor = element_blank(),
        # remove major x grid lines
        panel.grid.major.x = element_blank(),
        # set y major grid lines to blue
        panel.grid.major.y = element_line(colour = "#E0EDF5"),
        # set panel spacing to 7mm
        panel.spacing = unit(7, "mm"),
        # set legend position to bottom of plot
        legend.position = "bottom",
        # set legend orientation to horizontal
        legend.direction = "horizontal")+
  # set fill values
  scale_fill_manual(values = c("#0E1F40", "#f6aa1c"),
                    labels = c("Home", "Visitor"))+
  # set x labels
  scale_x_discrete(labels = c("Home", "Visitor"))+
  # set y axis values
  scale_y_continuous(expand = expansion(mult = c(0, 0.05)))+
  # facet wrap by year
  facet_wrap(vars(year),
             nrow = 5,
             scales = "free_y")
```

```{r fields data, echo=FALSE, warning=FALSE, message=FALSE}
# read in fields data ->
# data is from https://github.com/maxtoki/baseball_R/tree/master/data
fields <- read_csv(here::here("data/fields.csv"))
```

```{r parse retrosheet, echo=FALSE, message=FALSE, warning=FALSE}
# read in the parse_retrosheet_pbp() function from script directory ->
# function from https://github.com/beanumber/baseball_R/blob/master/scripts/parse_retrosheet_pbp.R ->
# has been updated to use here::here()
source(here::here("script/parse_retrosheet_pbp.R"))

# create datasets for seasons 2000-2020 ->
# using the parse_retrosheet_pbp() function
parse_retrosheet_pbp(2000)
parse_retrosheet_pbp(2001)
parse_retrosheet_pbp(2002)
parse_retrosheet_pbp(2003)
parse_retrosheet_pbp(2004)
parse_retrosheet_pbp(2005)
parse_retrosheet_pbp(2006)
parse_retrosheet_pbp(2007)
parse_retrosheet_pbp(2008)
parse_retrosheet_pbp(2009)
parse_retrosheet_pbp(2010)
parse_retrosheet_pbp(2011)
parse_retrosheet_pbp(2012)
parse_retrosheet_pbp(2013)
parse_retrosheet_pbp(2014)
parse_retrosheet_pbp(2015)
parse_retrosheet_pbp(2016)
parse_retrosheet_pbp(2017)
parse_retrosheet_pbp(2018)
parse_retrosheet_pbp(2019)
parse_retrosheet_pbp(2020)
```

```{r season data, echo=FALSE, message=FALSE, warning=FALSE}
# create temporary placeholder to hold list of all____.csv files
t1 <- list.files(path = here::here("data"), pattern = ".*all.*\\.csv$")
# create temporary placeholder for df renames
t2 <- c("df2000", "df2001", "df2002", "df2003", "df2004", "df2005",
        "df2006", "df2007", "df2008", "df2009", "df2010", "df2011",
        "df2012", "df2013", "df2014", "df2015", "df2016", "df2017",
        "df2018", "df2019", "df2020")

# for the length of the first temporary vector
for(i in 1:length(t1)){
  # assign the matching character string from t2 ->
  # as a dataframe read in using read_csv() from readr ->
  # pull in column names from fields data and Header ->
  # set NA to character
  assign(t2[i], readr::read_csv(here::here("data", t1[i]),
                         col_names = pull(fields, Header), 
                         na = character()) %>%
           dplyr::rename_all(tolower) %>% 
           # mutate new column runs ->
           # new column half_inning ->
           # and new column runs_scored, using mutate() from dplyr
           dplyr::mutate(runs = away_score_ct + home_score_ct,
                  half_inning = paste(game_id, inn_ct, bat_home_id),
                  runs_scored = (bat_dest_id > 3) + (run1_dest_id > 3) +
                    (run2_dest_id > 3) + (run3_dest_id > 3)))
}


# for the length of the second temporary vector
for(i in 1:length(t2)){
  # assign to a new data object with suffix _hi
  assign(paste0(t2[i], "_hi"),
         # group by the created half_inning column
         dplyr::group_by(get(t2[i]), half_inning) %>% 
         # summarize outs_inning as sum of event_outs_ct   
         dplyr::summarize(outs_inning = sum(event_outs_ct),
                   # summarize runs_inning as a sum of runs_scored      
                   runs_inning = sum(runs_scored),
                   # summarize runs_start as the first value of runs
                   runs_start = dplyr::first(runs),
                   # summarize max_runs as runs_inning + runs_start
                   max_runs = runs_inning + runs_start))
}

# create third temporary holder for "hi" dataset names
# for the length of t2
# paste _hi to the end of the index object
for(i in 1:length(t2)){
  t3[i] = paste0(t2[i], "_hi")
}

# join half_inning data to full season data ->
# for the length of t2
for(i in 1:length(t2)){
  # assign the name at the index location in t2 ->
  # join the object at the index location in t2 with object in t3 ->
  # join by half_inning column
  assign(t2[i], dplyr::inner_join(get(t2[i]), get(t3[i]), by = "half_inning") %>%
           # mutate new column runs in the remainder of inning as ->
           # maxmimum runs - runs
           mutate(runs_roi = max_runs - runs))
}
```
